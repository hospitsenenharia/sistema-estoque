<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema de Estoque</title>
<style>
  :root{
    --accent:#0b78d1;
    --danger:#e04b4b;
    --muted:#7b8694;
    --card:rgba(255,255,255,0.98);
    --glass: rgba(255,255,255,0.06);
    --radius:12px;
    --ease: cubic-bezier(.2,.9,.3,1);
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
  html,body{height:100%;margin:0;background:linear-gradient(160deg, rgba(11,120,209,0.06), rgba(6,167,125,0.04)), url('https://images.unsplash.com/photo-1503387762-592deb58ef4e?auto=format&fit=crop&w=1800&q=60') center/cover fixed no-repeat; color:#0b1220; -webkit-font-smoothing:antialiased;}
  /* header & layout (hidden until login) */
  header, footer, .container { transition: opacity .25s ease; }
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 22px;background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));backdrop-filter: blur(6px);position:sticky;top:0;z-index:5;border-bottom:1px solid rgba(255,255,255,0.03)}
  .logo{width:44px;height:44px;border-radius:10px;object-fit:cover;box-shadow:0 6px 18px rgba(11,120,209,0.12)}
  h1{font-size:18px;margin:0;color:#fff}
  .user-info{color:rgba(255,255,255,0.9);font-weight:600;background: rgba(0,0,0,0.18);padding:6px 10px;border-radius:999px}
  .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all .18s var(--ease)}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.08)}
  .container{max-width:1200px;margin:26px auto;padding:18px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.94));box-shadow:0 20px 60px rgba(2,6,23,0.28)}
  nav.menu{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .menu-btn{background:transparent;border:none;padding:8px 12px;border-radius:10px;color:#0b1220;font-weight:600;cursor:pointer}
  .card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(2,6,23,0.04)}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid rgba(2,6,23,0.04)}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);width:100%;font-size:14px}
  .thumb{width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid rgba(2,6,23,0.04)}
  .prod-card{display:flex;gap:12px;align-items:center;padding:10px;background:linear-gradient(180deg,#fff,#fbfbfb);border-radius:10px}
  .muted{color:var(--muted);font-size:13px}
  footer{padding:14px;text-align:center;color:rgba(0,0,0,0.6);margin-top:16px}
  /* Login overlay covering entire screen (isolated) */
  #loginOverlay {
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(rgba(2,6,23,0.55), rgba(2,6,23,0.55));
    z-index:9999;
  }
  .login-box{
    width:420px;
    background:rgba(255,255,255,0.98);
    padding:20px;
    border-radius:12px;
    box-shadow:0 30px 80px rgba(2,6,23,0.5);
    text-align:left;
  }
  .login-box h2{margin-top:0;margin-bottom:8px}
  .note{font-size:13px;color:var(--muted)}
  @media(max-width:640px){
    .login-box{width:92%}
    .thumb{width:48px;height:48px}
  }
</style>
</head>
<body>
  <!-- Login overlay: visible quando usuário NÃO está logado -->
  <div id="loginOverlay" aria-hidden="false">
    <div class="login-box" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <h2 id="loginTitle">Entrar no Sistema</h2>

      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:8px">
        <div>
          <label for="loginUser">Usuário</label><br>
          <input id="loginUser" type="text" placeholder="seu login">
        </div>
        <div>
          <label for="loginPass">Senha</label><br>
          <input id="loginPass" type="password" placeholder="sua senha">
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center">
        <!-- Demo deixa de expor credenciais; apenas cria dados para testar -->
        <button class="btn ghost" onclick="seedDemo()">Demo</button>
        <button class="btn" onclick="login()">Entrar</button>
      </div>

      <p class="note" style="margin-top:12px">Observação: este é um protótipo local. Para produção, implemente backend seguro (HTTPS, 2FA, RBAC).</p>
    </div>
  </div>

  <!-- Header + App (ocultos até login) -->
  <header id="appHeader" style="display:none">
    <div style="display:flex;gap:12px;align-items:center">
      <img class="logo" src="https://images.unsplash.com/photo-1542444459-db5bfb40e5c6?auto=format&fit=crop&w=80&q=60" alt="logo">
      <div>
        <h1 style="color:#fff;margin:0">Sistema de Estoque</h1>
        <div class="muted" style="font-size:13px;color:rgba(255,255,255,0.85)">Controle de requisições e estoque</div>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <div class="user-info" id="userInfo">Usuário: —</div>
      <button class="btn ghost" id="btnLogout" onclick="logout()" style="display:none">Sair</button>
    </div>
  </header>

  <div class="container" id="appContainer" style="display:none">
    <nav class="menu" id="mainMenu" style="margin-bottom:12px">
      <button class="menu-btn" onclick="show('dashboard', this)">Dashboard</button>
      <button class="menu-btn" onclick="show('requisicoes', this)">Requisições</button>
      <button class="menu-btn" id="menuMateriais" onclick="show('materiais', this)">Cadastro de Estoque</button>
      <button class="menu-btn" id="menuUsuarios" onclick="show('usuarios', this)">Usuários</button>
    </nav>

    <main>
      <section id="dashboardSec" class="card">
        <h2>Visão Geral</h2>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <div style="flex:1;min-width:160px" class="card">
            <div class="muted">Materiais</div><div style="font-size:20px;font-weight:700" id="countMateriais">0</div>
          </div>
          <div style="flex:1;min-width:160px" class="card">
            <div class="muted">Requisições</div><div style="font-size:20px;font-weight:700" id="countReqs">0</div>
          </div>
          <div style="flex:1;min-width:160px" class="card">
            <div class="muted">Usuários</div><div style="font-size:20px;font-weight:700" id="countUsers">0</div>
          </div>
        </div>
      </section>

      <section id="requisicoesSec" class="card hidden">
        <h2>Requisições</h2>
        <div style="display:flex;gap:12px;align-items:end;margin-bottom:16px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <label>Solicitante</label><br>
            <input id="reqSolicitante" placeholder="Nome será preenchido automaticamente">
          </div>
          <div style="flex:1;min-width:220px">
            <label>Produto</label><br>
            <select id="selProduto"></select>
          </div>
          <div style="width:120px">
            <label>Quantidade</label><br>
            <input id="reqQtd" type="number" min="1" value="1">
          </div>
          <div>
            <button class="btn" onclick="criarRequisicao()">Enviar</button>
          </div>
        </div>

        <h3>Materiais disponíveis</h3>
        <div id="prodListForTech" style="display:flex;flex-direction:column;gap:10px;margin-bottom:14px"></div>

        <h3>Minhas Requisições</h3>
        <table>
          <thead><tr><th>ID</th><th>Produto</th><th>Qtd</th><th>Solicitante</th><th>Status</th></tr></thead>
          <tbody id="tbRequisicoes"></tbody>
        </table>
      </section>

      <section id="materiaisSec" class="card hidden">
        <h2>Cadastro de Estoque</h2>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
          <input id="matNome" placeholder="Nome do material" style="flex:1;min-width:200px">
          <input id="matCodigo" placeholder="Código" style="width:180px">
          <input id="matQtd" type="number" placeholder="Quantidade" value="0" style="width:110px">
          <label style="display:flex;flex-direction:column;gap:6px">
            Imagem (max 1.5MB)
            <input id="matImage" type="file" accept="image/*">
          </label>
          <button class="btn" onclick="adicionarMaterial()">Salvar</button>
        </div>

        <h3>Materiais cadastrados</h3>
        <table>
          <thead><tr><th>Imagem</th><th>Nome</th><th>Código</th><th>Qtd</th><th>Ações</th></tr></thead>
          <tbody id="tbMateriaisAdmin"></tbody>
        </table>
      </section>

      <section id="usuariosSec" class="card hidden">
        <h2>Usuários / Técnicos</h2>
        <div id="userControls" style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
          <input id="newUserName" placeholder="Nome do técnico" style="min-width:180px">
          <input id="newUserLogin" placeholder="Login" style="min-width:130px">
          <input id="newUserPass" type="password" placeholder="Senha" style="min-width:130px">
          <button class="btn" onclick="criarUsuario()">Criar Técnico</button>
        </div>

        <table>
          <thead><tr><th>Nome</th><th>Login</th><th>Perfil</th><th>Ações</th></tr></thead>
          <tbody id="tbUsuarios"></tbody>
        </table>
      </section>
    </main>
  </div>

  <footer id="appFooter" style="display:none">
    © <span id="ano"></span> Sistema de Estoque — desenvolvido por você
  </footer>

<script>
/* =========================
   Dados (localStorage)
   ========================= */
let users = JSON.parse(localStorage.getItem('sys_users') || '[]');
let materiais = JSON.parse(localStorage.getItem('sys_materiais') || '[]');
let requisicoes = JSON.parse(localStorage.getItem('sys_requisicoes') || '[]');
let currentUser = JSON.parse(localStorage.getItem('sys_currentUser') || 'null');

/* Utilitários */
function saveAll(){
  localStorage.setItem('sys_users', JSON.stringify(users));
  localStorage.setItem('sys_materiais', JSON.stringify(materiais));
  localStorage.setItem('sys_requisicoes', JSON.stringify(requisicoes));
  localStorage.setItem('sys_currentUser', JSON.stringify(currentUser));
  atualizarUI();
}

function ensureDefaultUsers(){
  if(users.length === 0){
    users.push({id:1, username:'admin', password:'12345', role:'Administrador', name:'Administrador'});
    saveAll();
  }
}

/* Autenticação */
function login(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if(!u || !p){ alert('Informe usuário e senha'); return; }
  const found = users.find(x => x.username === u && x.password === p);
  if(!found){ alert('Usuário ou senha inválidos'); return; }
  currentUser = found;
  localStorage.setItem('sys_currentUser', JSON.stringify(currentUser));
  // mostra app e oculta login
  document.getElementById('loginOverlay').style.display = 'none';
  document.getElementById('appHeader').style.display = '';
  document.getElementById('appContainer').style.display = '';
  document.getElementById('appFooter').style.display = '';
  document.getElementById('btnLogout').style.display = 'inline-block';
  atualizarUI();
}

/* Demo: cria dados e faz login automático como admin (sem exibir senha) */
function seedDemo(){
  ensureDefaultUsers();
  materiais = [
    {id:1,nome:'Parafuso 3/8',codigo:'PAR-038',qtd:120,min:20,image:null},
    {id:2,nome:'Luva de Procedimento',codigo:'LUV-001',qtd:40,min:10,image:null},
    {id:3,nome:'Álcool 70%',codigo:'ALC-070',qtd:8,min:20,image:null}
  ];
  requisicoes = [];
  currentUser = users.find(u=>u.username==='admin');
  saveAll();
  // abrir app
  document.getElementById('loginOverlay').style.display = 'none';
  document.getElementById('appHeader').style.display = '';
  document.getElementById('appContainer').style.display = '';
  document.getElementById('appFooter').style.display = '';
  document.getElementById('btnLogout').style.display = 'inline-block';
  atualizarUI();
}

/* Logout */
function logout(){
  if(confirm('Deseja encerrar sessão?')){
    currentUser = null;
    localStorage.removeItem('sys_currentUser');
    // esconder app, mostrar apenas login
    document.getElementById('loginOverlay').style.display = '';
    document.getElementById('appHeader').style.display = 'none';
    document.getElementById('appContainer').style.display = 'none';
    document.getElementById('appFooter').style.display = 'none';
    document.getElementById('btnLogout').style.display = 'none';
    atualizarUI();
  }
}

/* Navegação simples */
function show(sectionKey, btn){
  const map = { dashboard: 'dashboardSec', requisicoes: 'requisicoesSec', materiais: 'materiaisSec', usuarios: 'usuariosSec' };
  const secId = map[sectionKey] || sectionKey;
  // permission checks
  if((secId === 'materiaisSec' || secId === 'usuariosSec') && (!currentUser || currentUser.role !== 'Administrador')){
    alert('Acesso negado: apenas Administrador.');
    return;
  }
  document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
  const el = document.getElementById(secId);
  if(el) el.classList.remove('hidden');
}

/* UI Rendering */
function atualizarUI(){
  document.getElementById('ano').innerText = new Date().getFullYear();
  document.getElementById('countMateriais').innerText = materiais.length;
  document.getElementById('countReqs').innerText = requisicoes.length;
  document.getElementById('countUsers').innerText = users.length;
  document.getElementById('userInfo').innerText = currentUser ? `${currentUser.name || currentUser.username} (${currentUser.role})` : 'Usuário: —';

  // menu visibility and controls
  const menuMat = document.getElementById('menuMateriais');
  const menuUsu = document.getElementById('menuUsuarios');
  const userControls = document.getElementById('userControls');
  menuMat.style.display = 'none';
  menuUsu.style.display = 'none';
  userControls.style.display = 'none';
  document.getElementById('btnLogout').style.display = currentUser ? 'inline-block' : 'none';

  if(currentUser){
    if(currentUser.role === 'Administrador'){
      menuMat.style.display = '';
      menuUsu.style.display = '';
      userControls.style.display = 'flex';
    }
    // show dashboard by default if none visible
    if(document.querySelectorAll('main section:not(.hidden)').length === 0) show('dashboard');
  }

  // lists/tables
  renderMateriais();
  renderMateriaisForTech();
  renderMateriaisAdmin();
  renderUsuarios();
  renderRequisicoes();

  // auto-fill requester for technicians
  const reqInput = document.getElementById('reqSolicitante');
  if(reqInput){
    if(currentUser && currentUser.role === 'Técnico'){
      reqInput.value = currentUser.name && currentUser.name.trim() ? currentUser.name : currentUser.username;
      reqInput.readOnly = true;
      reqInput.style.background = '#f6f8fa';
    } else {
      reqInput.readOnly = false;
      reqInput.value = '';
      reqInput.style.background = '';
    }
  }
}

/* Materiais (Admin) */
function adicionarMaterial(){
  if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode cadastrar materiais.'); return; }
  const nome = document.getElementById('matNome').value.trim();
  const codigo = document.getElementById('matCodigo').value.trim();
  const qtd = Number(document.getElementById('matQtd').value || 0);
  const file = document.getElementById('matImage').files[0];
  if(!nome){ alert('Informe o nome do material'); return; }

  function pushMaterial(imageData){
    materiais.push({ id: Date.now(), nome, codigo, qtd, min:1, image: imageData || null });
    document.getElementById('matNome').value=''; document.getElementById('matCodigo').value=''; document.getElementById('matQtd').value=0; document.getElementById('matImage').value='';
    saveAll();
  }

  if(file){
    const maxBytes = 1.5 * 1024 * 1024;
    if(file.size > maxBytes){ alert('Imagem muito grande. Máx 1.5 MB.'); return; }
    const reader = new FileReader();
    reader.onload = function(e){ pushMaterial(e.target.result); };
    reader.onerror = function(){ alert('Erro ao ler imagem'); pushMaterial(null); };
    reader.readAsDataURL(file);
  } else {
    pushMaterial(null);
  }
}

function renderMateriais(){
  const sel = document.getElementById('selProduto');
  if(!sel) return;
  sel.innerHTML = '';
  materiais.forEach((m, idx) => sel.innerHTML += `<option value="${idx}">${m.nome} (${m.codigo||'-'}) — Qtd:${m.qtd}</option>`);
}

function renderMateriaisAdmin(){
  const tb = document.getElementById('tbMateriaisAdmin');
  if(!tb) return;
  tb.innerHTML = '';
  materiais.forEach((m,i)=>{
    const imgHtml = m.image ? `<img src="${m.image}" class="thumb" alt="${m.nome}">` : `<div style="width:64px;height:64px;border-radius:8px;background:#f3f3f3;display:flex;align-items:center;justify-content:center;color:#999">No</div>`;
    tb.innerHTML += `<tr>
      <td style="width:76px">${imgHtml}</td>
      <td>${m.nome}</td>
      <td>${m.codigo||'-'}</td>
      <td>${m.qtd}</td>
      <td><button class="btn" style="background:var(--danger)" onclick="delMaterial(${i})">Excluir</button></td>
    </tr>`;
  });
}

function delMaterial(i){ if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode excluir.'); return; } if(confirm('Confirmar exclusão do material?')){ materiais.splice(i,1); saveAll(); } }

/* Materiais for technicians */
function renderMateriaisForTech(){
  const container = document.getElementById('prodListForTech');
  if(!container) return;
  container.innerHTML = '';
  materiais.forEach(m=>{
    const img = m.image ? `<img src="${m.image}" class="thumb" alt="${m.nome}">` : `<div style="width:64px;height:64px;border-radius:8px;background:#f3f3f3;display:flex;align-items:center;justify-content:center;color:#999">No</div>`;
    const low = (m.min !== undefined && m.qtd <= m.min) ? `<div style="color:var(--danger);font-weight:700">Estoque baixo</div>` : `<div class="muted">Disponível: ${m.qtd}</div>`;
    const card = document.createElement('div');
    card.className = 'prod-card';
    card.innerHTML = `${img}<div style="flex:1"><div style="font-weight:700">${m.nome}</div><div class="muted">Código: ${m.codigo||'-'}</div>${low}</div><div style="min-width:90px;text-align:right" class="muted">Qtd: ${m.qtd}</div>`;
    container.appendChild(card);
  });
}

/* Usuários (Admin) */
function criarUsuario(){
  if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode criar usuários.'); return; }
  const name = document.getElementById('newUserName').value.trim();
  const login = document.getElementById('newUserLogin').value.trim();
  const pass = document.getElementById('newUserPass').value.trim();
  if(!name || !login || !pass){ alert('Preencha nome, login e senha'); return; }
  if(users.find(u=>u.username === login)){ alert('Login já existe'); return; }
  users.push({ id: Date.now(), username: login, password: pass, role: 'Técnico', name });
  document.getElementById('newUserName').value=''; document.getElementById('newUserLogin').value=''; document.getElementById('newUserPass').value='';
  saveAll(); alert('Técnico criado.');
}

function renderUsuarios(){
  const tb = document.getElementById('tbUsuarios');
  if(!tb) return;
  tb.innerHTML = '';
  users.forEach((u,i)=>{
    tb.innerHTML += `<tr>
      <td>${u.name}</td>
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td><button class="btn ghost" onclick="editarUsuario(${i})">Editar</button> <button class="btn" style="background:var(--danger)" onclick="deletarUsuario(${i})">Excluir</button></td>
    </tr>`;
  });
}
function editarUsuario(i){
  if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode editar usuários.'); return; }
  const novoNome = prompt('Editar nome:', users[i].name); if(novoNome !== null) users[i].name = novoNome;
  const novoLogin = prompt('Editar login:', users[i].username); if(novoLogin !== null) users[i].username = novoLogin;
  const novoPass = prompt('Nova senha (deixe em branco para manter):',''); if(novoPass) users[i].password = novoPass;
  saveAll();
}
function deletarUsuario(i){ if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode excluir usuários.'); return; } if(confirm('Confirmar exclusão?')){ users.splice(i,1); saveAll(); } }

/* Requisições */
function criarRequisicao(){
  if(!currentUser || currentUser.role !== 'Técnico'){ alert('Apenas Técnicos podem criar requisições.'); return; }
  const solicitanteName = currentUser.name && currentUser.name.trim() ? currentUser.name : currentUser.username;
  const solicitanteUser = currentUser.username;
  const prodIndex = Number(document.getElementById('selProduto').value);
  if(isNaN(prodIndex)){ alert('Selecione um produto'); return; }
  const qtd = Number(document.getElementById('reqQtd').value || 1);
  const mat = materiais[prodIndex];
  if(!mat){ alert('Produto inválido'); return; }
  if(qtd <= 0){ alert('Quantidade inválida'); return; }
  if(qtd > mat.qtd){
    if(!confirm('Quantidade solicitada maior que estoque disponível. Deseja continuar?')) return;
  }
  const r = { id: 'REQ-'+Date.now(), produtoId: mat.id, produtoNome: mat.nome, qtd, solicitanteUser, solicitanteName, status: 'Enviado', criadoEm: new Date().toISOString() };
  requisicoes.unshift(r);
  saveAll();
  alert('Requisição enviada.');
  renderRequisicoes();
}
function renderRequisicoes(){
  const tb = document.getElementById('tbRequisicoes');
  if(!tb) return;
  tb.innerHTML = '';
  requisicoes.forEach((r)=>{
    if(currentUser && currentUser.role === 'Técnico' && r.solicitanteUser !== currentUser.username) return;
    tb.innerHTML += `<tr><td>${r.id}</td><td>${r.produtoNome}</td><td>${r.qtd}</td><td>${r.solicitanteName}</td><td>${r.status}</td></tr>`;
  });
}

/* Export */
function downloadData(){
  const data = { users, materiais, requisicoes };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'sistema_estoque_backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* Inicialização */
ensureDefaultUsers();
if(!currentUser){
  // show only login overlay (app stays hidden)
  document.getElementById('loginOverlay').style.display = '';
  document.getElementById('appHeader').style.display = 'none';
  document.getElementById('appContainer').style.display = 'none';
  document.getElementById('appFooter').style.display = 'none';
} else {
  document.getElementById('loginOverlay').style.display = 'none';
  document.getElementById('appHeader').style.display = '';
  document.getElementById('appContainer').style.display = '';
  document.getElementById('appFooter').style.display = '';
}
atualizarUI();

/* Expor funções globalmente */
window.login = login;
window.seedDemo = seedDemo;
window.logout = logout;
window.show = show;
window.adicionarMaterial = adicionarMaterial;
window.delMaterial = delMaterial;
window.criarUsuario = criarUsuario;
window.editarUsuario = editarUsuario;
window.deletarUsuario = deletarUsuario;
window.criarRequisicao = criarRequisicao;
window.downloadData = downloadData;
</script>
</body>
</html>
