<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema de Estoque</title>
<style>
  :root{
    --accent:#0b78d1;
    --accent-weak: rgba(11,120,209,.14);
    --accent-weak-hover: rgba(11,120,209,.22);
    --danger:#e04b4b;
    --danger-bg:#fff1f1;
    --muted:#7b8694;
    --card:rgba(255,255,255,0.98);
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
  html,body{
    height:100%;margin:0;
    background:linear-gradient(160deg, rgba(11,120,209,0.06), rgba(6,167,125,0.04)),
               url('https://images.unsplash.com/photo-1503387762-592deb58ef4e?auto=format&fit=crop&w=1800&q=60') center/cover fixed no-repeat;
    color:#0b1220; -webkit-font-smoothing:antialiased;
  }
  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:14px 22px;background:rgba(255,255,255,0.05);
    backdrop-filter: blur(6px);border-bottom:1px solid rgba(255,255,255,0.15)
  }
  h1{font-size:18px;margin:0;color:#fff}
  .user-info{color:#fff;font-weight:600;background: rgba(0,0,0,0.32);padding:6px 10px;border-radius:999px}
  .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;transition:.15s}
  .btn:hover{transform:translateY(-1px)}
  .btn.ghost{background:transparent;color:#0b1220;border:1px solid rgba(0,0,0,.15)}
  .container{max-width:1200px;margin:26px auto;padding:18px;border-radius:16px;background:rgba(255,255,255,0.96);box-shadow:0 20px 60px rgba(2,6,23,0.28)}
  nav.menu{
    display:flex;gap:10px;margin-bottom:16px;padding:10px;border-radius:12px;
    background:rgba(255,255,255,.75);backdrop-filter: blur(6px);border:1px solid rgba(11,120,209,.12)
  }
  .menu-btn{
    background:var(--accent-weak);border:1px solid var(--accent-weak);
    padding:10px 14px;border-radius:10px;font-weight:700;min-width:140px;text-align:center;cursor:pointer
  }
  .menu-btn:hover{background:var(--accent-weak-hover)}
  .menu-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid rgba(2,6,23,0.08);vertical-align:top}
  input,select{padding:10px;border-radius:8px;border:1px solid rgba(2,6,23,0.12);width:100%;font-size:14px;background:#fff}
  .thumb{width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid rgba(2,6,23,0.08)}
  .prod-card{display:flex;gap:12px;align-items:center;padding:10px;background:linear-gradient(180deg,#fff,#f6f9ff);border-radius:10px;border:1px solid rgba(11,120,209,.08)}
  .prod-card.low{border-color:var(--danger);background:var(--danger-bg)}
  .muted{color:var(--muted);font-size:13px}
  .qty-low{color:var(--danger);font-weight:700}
  .row-low{background:var(--danger-bg)}
  /* Login overlay */
  #loginOverlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(rgba(2,6,23,0.55), rgba(2,6,23,0.55)); z-index:9999; }
  .login-box{ width:440px; background:rgba(255,255,255,0.98); padding:20px; border-radius:12px; box-shadow:0 30px 80px rgba(2,6,23,0.5); text-align:left; }
  .login-box h2{margin-top:0;margin-bottom:8px}
  @media(max-width:640px){ .container{margin:12px} .login-box{width:92%} .menu-btn{min-width:120px} }
</style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginOverlay" aria-hidden="false">
    <div class="login-box" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <h2 id="loginTitle">Entrar no Sistema</h2>
      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:8px">
        <div><label for="loginUser">Usuário</label><br><input id="loginUser" type="text" placeholder="seu login" autocomplete="username"></div>
        <div><label for="loginPass">Senha</label><br><input id="loginPass" type="password" placeholder="sua senha" autocomplete="current-password"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;flex-wrap:wrap">
        <button class="btn" onclick="login()">Entrar</button>
      </div>
      <div id="loginMsg" class="muted" style="margin-top:8px;display:none"></div>
      <div id="lockMsg" class="muted" style="margin-top:8px;display:none"></div>
      <div style="margin-top:6px"><button class="btn ghost" onclick="hardReset()" style="font-size:12px;padding:6px 10px">Limpar dados locais</button></div>
    </div>
  </div>

  <!-- HEADER (sem logo) -->
  <header id="appHeader" style="display:none">
    <div style="display:flex;gap:12px;align-items:center">
      <div>
        <h1>Sistema de Estoque</h1>
        <div class="muted" style="font-size:13px;color:rgba(255,255,255,0.85)">Controle de requisições e estoque</div>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <div class="user-info" id="userInfo">Usuário: —</div>
      <button class="btn" id="btnLogout" onclick="logout()" style="display:none">Sair</button>
    </div>
  </header>

  <div class="container" id="appContainer" style="display:none">
    <nav class="menu" id="mainMenu">
      <button class="menu-btn active" onclick="show('dashboard', this)">Dashboard</button>
      <button class="menu-btn" onclick="show('requisicoes', this)">Requisições</button>
      <button class="menu-btn" id="menuMateriais" onclick="show('materiais', this)">Cadastro de Estoque</button>
      <button class="menu-btn" id="menuUsuarios" onclick="show('usuarios', this)">Usuários</button>
    </nav>

    <main>
      <!-- DASHBOARD -->
      <section id="dashboardSec" class="card">
        <h2>Visão Geral</h2>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <div style="flex:1;min-width:160px" class="card"><div class="muted">Materiais</div><div style="font-size:20px;font-weight:700" id="countMateriais">0</div></div>
          <div style="flex:1;min-width:160px" class="card"><div class="muted">Requisições</div><div style="font-size:20px;font-weight:700" id="countReqs">0</div></div>
          <div style="flex:1;min-width:160px" class="card"><div class="muted">Usuários</div><div style="font-size:20px;font-weight:700" id="countUsers">0</div></div>
        </div>
      </section>

      <!-- REQUISIÇÕES -->
      <section id="requisicoesSec" class="card hidden">
        <h2>Requisições</h2>
        <div style="display:flex;gap:12px;align-items:end;margin-bottom:16px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <label>Solicitante</label><br>
            <input id="reqSolicitante" placeholder="Nome será preenchido automaticamente">
          </div>
          <div style="flex:1;min-width:220px">
            <label>Produto</label><br>
            <select id="selProduto" onchange="onProdutoChange()"></select>
          </div>
          <div style="width:150px"><label>Marca</label><br><input id="reqMarca" type="text" placeholder="Ex.: Intelbras"></div>
          <div style="width:150px"><label>Modelo</label><br><input id="reqModelo" type="text" placeholder="Ex.: X-200"></div>
          <div style="width:120px"><label>Quantidade</label><br><input id="reqQtd" type="number" min="1" value="1"></div>
          <div><button class="btn" onclick="criarRequisicao()">Enviar</button></div>
        </div>

        <h3>Materiais disponíveis</h3>
        <div id="prodListForTech" style="display:flex;flex-direction:column;gap:10px;margin-bottom:14px"></div>

        <h3>Minhas Requisições</h3>
        <table>
          <thead><tr><th>ID</th><th>Produto</th><th>Marca</th><th>Modelo</th><th>Qtd</th><th>Solicitante</th><th>Status</th></tr></thead>
          <tbody id="tbRequisicoes"></tbody>
        </table>
      </section>

      <!-- MATERIAIS -->
      <section id="materiaisSec" class="card hidden">
        <h2>Cadastro de Estoque</h2>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
          <input id="matNome" placeholder="Nome do material" style="flex:1;min-width:220px">
          <input id="matCodigo" placeholder="Código" style="width:150px">
          <input id="matMarca" placeholder="Marca" style="width:140px">
          <input id="matModelo" placeholder="Modelo" style="width:140px">
          <input id="matMin" type="number" placeholder="Estoque mínimo" value="1" style="width:150px">
          <input id="matQtd" type="number" placeholder="Qtd" value="0" style="width:100px">
          <label style="display:flex;flex-direction:column;gap:6px">Imagem (max 1.5MB)
            <input id="matImage" type="file" accept="image/*">
          </label>
          <button class="btn" onclick="adicionarMaterial()">Salvar</button>
        </div>

        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="filtroBaixo" onchange="renderMateriaisAdmin()">
            Mostrar apenas estoque baixo
          </label>
        </div>

        <h3>Materiais cadastrados</h3>
        <table>
          <thead><tr><th>Imagem</th><th>Nome</th><th>Código / Marca / Modelo</th><th>Qtd</th><th>Mín.</th><th>Ações</th></tr></thead>
          <tbody id="tbMateriaisAdmin"></tbody>
        </table>
      </section>

      <!-- USUÁRIOS -->
      <section id="usuariosSec" class="card hidden">
        <h2>Usuários / Técnicos</h2>
        <div id="userControls" style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
          <input id="newUserName" placeholder="Nome do usuário" style="min-width:180px">
          <input id="newUserLogin" placeholder="Login" style="min-width:130px">
          <input id="newUserPass" type="password" placeholder="Senha (mín. 6)" style="min-width:130px">
          <input id="newUserPass2" type="password" placeholder="Confirmar senha" style="min-width:130px">
          <select id="newUserRole" style="min-width:160px">
            <option value="Técnico">Técnico</option>
            <option value="Administrador">Administrador</option>
          </select>
          <button class="btn" onclick="criarUsuario()">Criar Usuário</button>
        </div>

        <table>
          <thead><tr><th>Nome</th><th>Login</th><th>Perfil</th><th>Ações</th></tr></thead>
          <tbody id="tbUsuarios"></tbody>
        </table>
      </section>
    </main>
  </div>

<script>
/* ========= Storage ========= */
function safeParse(key, fallback){
  try{ const v = localStorage.getItem(key); return v? JSON.parse(v) : fallback; }
  catch(e){ console.warn('Storage corrompido em', key, e); return fallback; }
}
let users        = safeParse('sys_users', []);
let materiais    = safeParse('sys_materiais', []);
let requisicoes  = safeParse('sys_requisicoes', []);
let currentUser  = safeParse('sys_currentUser', null);

/* ========= Login: tentativas/bloqueio ========= */
let loginAttempts = Number(localStorage.getItem('sys_login_attempts') || '0');
let lockUntil     = Number(localStorage.getItem('sys_login_lock_until') || '0');

function saveAll(){
  localStorage.setItem('sys_users', JSON.stringify(users));
  localStorage.setItem('sys_materiais', JSON.stringify(materiais));
  localStorage.setItem('sys_requisicoes', JSON.stringify(requisicoes));
  localStorage.setItem('sys_currentUser', JSON.stringify(currentUser));
  localStorage.setItem('sys_login_attempts', String(loginAttempts));
  localStorage.setItem('sys_login_lock_until', String(lockUntil));
  atualizarUI();
}
function ensureDefaultUsers(){
  if(users.length === 0){
    users.push({id:1, username:'admin', password:'12345', role:'Administrador', name:'Administrador'});
    saveAll();
  }
}
function countAdmins(){ return users.filter(u=>u.role==='Administrador').length; }

/* ========= Correção de legado ========= */
function fixLegacyRequisicoes(){
  let changed = false;
  requisicoes.forEach(r=>{
    if(!r.solicitanteName){
      const u = users.find(x=> x.username === r.solicitanteUser);
      if(u && u.name){ r.solicitanteName = u.name; changed = true; }
      else if(r.solicitanteUser){ r.solicitanteName = r.solicitanteUser; changed = true; }
    }
    if(!r.status){ r.status = 'Enviado'; changed = true; }
  });
  if(changed) saveAll();
}

/* ========= Auth ========= */
function login(){
  const uEl = document.getElementById('loginUser');
  const pEl = document.getElementById('loginPass');
  const msg = document.getElementById('loginMsg');
  const lock = document.getElementById('lockMsg');
  const u = (uEl?.value||'').trim();
  const p = (pEl?.value||'').trim();
  msg.style.display = 'none'; lock.style.display='none';

  // bloqueio
  const now = Date.now();
  if(lockUntil && now < lockUntil){
    const mins = Math.ceil((lockUntil - now)/60000);
    const text = `Login bloqueado por tentativas falhas. Tente novamente em ${mins} minuto(s).`;
    lock.innerText = text; lock.style.display='';
    return;
  }

  if(!u || !p){ msg.innerText = 'Informe usuário e senha.'; msg.style.display = ''; return; }
  const found = users.find(x => x.username === u && x.password === p);
  if(!found){
    loginAttempts++;
    if(loginAttempts>=5){
      lockUntil = Date.now() + 10*60*1000; // 10 min
      loginAttempts = 0; saveAll();
      lock.innerText = 'Muitas tentativas com erro. Acesso bloqueado por 10 minutos.';
      lock.style.display=''; return;
    }
    saveAll();
    msg.innerText = 'Usuário ou senha inválidos.'; msg.style.display=''; return;
  }
  // sucesso
  loginAttempts = 0; lockUntil = 0;
  currentUser = found; localStorage.setItem('sys_currentUser', JSON.stringify(currentUser));
  document.getElementById('loginOverlay').style.display = 'none';
  document.getElementById('appHeader').style.display = '';
  document.getElementById('appContainer').style.display = '';
  document.getElementById('btnLogout').style.display = 'inline-block';
  saveAll();
}
function logout(){
  if(confirm('Deseja encerrar sessão?')){
    currentUser = null; localStorage.removeItem('sys_currentUser'); location.reload();
  }
}

/* ========= Navegação ========= */
function show(sectionKey, btn){
  const map = { dashboard: 'dashboardSec', requisicoes: 'requisicoesSec', materiais: 'materiaisSec', usuarios: 'usuariosSec' };
  const secId = map[sectionKey] || sectionKey;
  if((secId === 'materiaisSec' || secId === 'usuariosSec') && (!currentUser || currentUser.role !== 'Administrador')){
    alert('Acesso negado: apenas Administrador.'); return;
  }
  document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
  const el = document.getElementById(secId); if(el) el.classList.remove('hidden');
  document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

/* ========= UI ========= */
function atualizarUI(){
  const cm = document.getElementById('countMateriais');
  const cr = document.getElementById('countReqs');
  const cu = document.getElementById('countUsers');
  if(cm) cm.innerText = materiais.length;
  if(cr) cr.innerText = requisicoes.length;
  if(cu) cu.innerText = users.length;

  const ui = document.getElementById('userInfo');
  if(ui) ui.innerText = currentUser ? `${currentUser.name || currentUser.username} (${currentUser.role})` : 'Usuário: —';

  const isAdmin = currentUser && currentUser.role === 'Administrador';
  const menuMat = document.getElementById('menuMateriais');
  const menuUsu = document.getElementById('menuUsuarios');
  const userControls = document.getElementById('userControls');
  if(menuMat) menuMat.style.display = isAdmin ? '' : 'none';
  if(menuUsu) menuUsu.style.display = isAdmin ? '' : 'none';
  if(userControls) userControls.style.display = isAdmin ? 'flex' : 'none';

  if(currentUser && document.querySelectorAll('main section:not(.hidden)').length === 0){
    show('dashboard', document.querySelector('.menu-btn'));
  }

  renderMateriais();
  renderMateriaisForTech();
  renderMateriaisAdmin();
  renderUsuarios();
  renderRequisicoes();

  // auto-preencher solicitante (somente técnico)
  const reqInput = document.getElementById('reqSolicitante');
  if(reqInput){
    if(currentUser && currentUser.role === 'Técnico'){
      reqInput.value = currentUser.name && currentUser.name.trim() ? currentUser.name : currentUser.username;
      reqInput.readOnly = true; reqInput.style.background = '#f6f8fa';
    } else { reqInput.readOnly = false; reqInput.value=''; reqInput.style.background=''; }
  }
}

/* ========= Materiais ========= */
function adicionarMaterial(){
  if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode cadastrar materiais.'); return; }
  const nome   = document.getElementById('matNome').value.trim();
  const codigo = document.getElementById('matCodigo').value.trim();
  const marca  = document.getElementById('matMarca').value.trim();
  const modelo = document.getElementById('matModelo').value.trim();
  const min    = Number(document.getElementById('matMin').value || 1);
  const qtd    = Number(document.getElementById('matQtd').value || 0);
  const file   = document.getElementById('matImage').files[0];
  if(!nome){ alert('Informe o nome do material'); return; }

  function pushMaterial(imageData){
    materiais.push({ id: Date.now(), nome, codigo, marca, modelo, qtd, min: isNaN(min)?1:min, image: imageData || null });
    document.getElementById('matNome').value='';
    document.getElementById('matCodigo').value='';
    document.getElementById('matMarca').value='';
    document.getElementById('matModelo').value='';
    document.getElementById('matMin').value=1;
    document.getElementById('matQtd').value=0;
    document.getElementById('matImage').value='';
    saveAll();
  }
  if(file){
    const maxBytes = 1.5 * 1024 * 1024;
    if(file.size > maxBytes){ alert('Imagem muito grande. Máx 1.5 MB.'); return; }
    const reader = new FileReader();
    reader.onload = e => pushMaterial(e.target.result);
    reader.onerror = () => { alert('Erro ao ler imagem'); pushMaterial(null); };
    reader.readAsDataURL(file);
  } else { pushMaterial(null); }
}

function renderMateriais(){
  const sel = document.getElementById('selProduto'); if(!sel) return;
  sel.innerHTML = '';
  materiais.forEach((m, idx) => {
    const extra = [m.codigo, m.marca, m.modelo].filter(Boolean).join(' · ');
    const extraStr = extra ? ' (' + extra + ')' : '';
    const flag = (m.min !== undefined && m.qtd <= m.min) ? ' ⚠️ baixo' : '';
    sel.innerHTML += `<option value="${idx}">${m.nome}${extraStr} — Qtd:${m.qtd}${flag}</option>`;
  });
}

function renderMateriaisAdmin(){
  const tb = document.getElementById('tbMateriaisAdmin'); if(!tb) return;
  const onlyLow = document.getElementById('filtroBaixo')?.checked;
  tb.innerHTML = '';
  materiais.forEach((m,i)=>{
    const low = (m.min !== undefined && m.qtd <= m.min);
    if(onlyLow && !low) return;
    const imgHtml = m.image ? `<img src="${m.image}" class="thumb" alt="${m.nome}">`
                            : `<div style="width:64px;height:64px;border-radius:8px;background:#f3f3f3;display:flex;align-items:center;justify-content:center;color:#999">No</div>`;
    tb.innerHTML += `<tr class="${low?'row-low':''}">
      <td style="width:76px">${imgHtml}</td>
      <td><strong>${m.nome}</strong><br><span class="muted">Marca: ${m.marca||'—'} · Modelo: ${m.modelo||'—'}</span></td>
      <td>${m.codigo||'—'}</td>
      <td class="${low?'qty-low':''}">${m.qtd}</td>
      <td class="${low?'qty-low':''}">${m.min ?? '—'}</td>
      <td><button class="btn" style="background:var(--danger)" onclick="delMaterial(${i})">Excluir</button></td>
    </tr>`;
  });
}
function delMaterial(i){
  if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode excluir.'); return; }
  if(confirm('Confirmar exclusão do material?')){ materiais.splice(i,1); saveAll(); }
}

function renderMateriaisForTech(){
  const container = document.getElementById('prodListForTech'); if(!container) return;
  container.innerHTML = '';
  materiais.forEach(m=>{
    const low = (m.min !== undefined && m.qtd <= m.min);
    const img = m.image ? `<img src="${m.image}" class="thumb" alt="${m.nome}">`
                        : `<div style="width:64px;height:64px;border-radius:8px;background:#e9f3ff;display:flex;align-items:center;justify-content:center;color:#1e3a8a">No</div>`;
    const lowHtml = low ? `<div class="qty-low">⚠️ Estoque baixo (mín: ${m.min||0})</div>` : `<div class="muted">Disponível: ${m.qtd}</div>`;
    const card = document.createElement('div');
    card.className = 'prod-card' + (low?' low':'');
    card.innerHTML = `${img}
      <div style="flex:1">
        <div style="font-weight:700">${m.nome}</div>
        <div class="muted">Marca: ${m.marca||'—'} · Modelo: ${m.modelo||'—'} · Código: ${m.codigo||'—'}</div>
        ${lowHtml}
      </div>
      <div style="min-width:90px;text-align:right" class="${low?'qty-low muted':'muted'}">Qtd: ${m.qtd}</div>`;
    container.appendChild(card);
  });
}

/* ========= Usuários ========= */
function criarUsuario(){
  if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode criar usuários.'); return; }
  const name = document.getElementById('newUserName').value.trim();
  const login = document.getElementById('newUserLogin').value.trim();
  const pass = document.getElementById('newUserPass').value;
  const pass2 = document.getElementById('newUserPass2').value;
  const role = document.getElementById('newUserRole').value;
  if(!name || !login || !pass){ alert('Preencha nome, login e senha'); return; }
  if(pass.length < 6){ alert('Senha muito curta. Use pelo menos 6 caracteres.'); return; }
  if(pass !== pass2){ alert('As senhas não conferem.'); return; }
  if(users.find(u=>u.username === login)){ alert('Login já existe'); return; }
  users.push({ id: Date.now(), username: login, password: pass, role, name });
  document.getElementById('newUserName').value='';
  document.getElementById('newUserLogin').value='';
  document.getElementById('newUserPass').value='';
  document.getElementById('newUserPass2').value='';
  document.getElementById('newUserRole').value='Técnico';
  saveAll();
  alert('Usuário criado.');
}

function renderUsuarios(){
  const tb = document.getElementById('tbUsuarios'); if(!tb) return;
  tb.innerHTML = '';
  users.forEach((u,i)=>{
    tb.innerHTML += `<tr>
      <td>${u.name}</td>
      <td>${u.username}</td>
      <td>
        <select onchange="alterarRole(${i}, this.value)">
          <option value="Administrador" ${u.role==='Administrador'?'selected':''}>Administrador</option>
          <option value="Técnico" ${u.role==='Técnico'?'selected':''}>Técnico</option>
        </select>
      </td>
      <td>
        <button class="btn ghost" onclick="resetUserPassword(${i})">Redefinir Senha</button>
        <button class="btn" style="background:var(--danger)" onclick="deletarUsuario(${i})">Excluir</button>
      </td>
    </tr>`;
  });
}

function alterarRole(i, novoRole){
  if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode alterar permissão.'); return; }
  if(novoRole!=='Administrador' && novoRole!=='Técnico'){ alert('Papel inválido.'); return; }
  const adminsAntes = countAdmins();
  const vaiRemoverUltimoAdmin = (users[i].role==='Administrador' && novoRole==='Técnico' && adminsAntes<=1);
  if(vaiRemoverUltimoAdmin){ alert('Não é possível rebaixar: este é o único Administrador.'); atualizarUI(); return; }
  users[i].role = novoRole; saveAll();
}

// Reset de senha: apenas Admin
function resetUserPassword(i){
  if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode redefinir senha.'); return; }
  const metodo = prompt('Escolha o método de redefinição:\n1) Padrão 12345\n2) Aleatória\n3) Manual');
  if(!metodo) return;
  if(metodo==='1'){
    users[i].password = '12345';
  } else if(metodo==='2'){
    const pwd = genRandomPassword(10); users[i].password = pwd; alert('Senha gerada: '+pwd);
  } else if(metodo==='3'){
    const nova = prompt('Digite a nova senha (mín. 6 caracteres):');
    if(!nova || nova.length<6){ alert('Senha muito curta.'); return; }
    users[i].password = nova;
  } else { alert('Opção inválida.'); return; }
  saveAll();
}
function genRandomPassword(n){
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%';
  let s=''; for(let i=0;i<n;i++){ s += c[Math.floor(Math.random()*c.length)]; } return s;
}

function deletarUsuario(i){
  if(!currentUser || currentUser.role !== 'Administrador'){ alert('Apenas Admin pode excluir usuários.'); return; }
  const u = users[i];
  if(u.role==='Administrador' && countAdmins()<=1){ alert('Não é possível excluir: este é o único Administrador.'); return; }
  if(confirm('Confirmar exclusão?')){ users.splice(i,1); saveAll(); }
}

/* ========= Requisições ========= */
function onProdutoChange(){
  const sel = document.getElementById('selProduto');
  const idx = Number(sel.value); const m = materiais[idx]; if(!m) return;
  document.getElementById('reqMarca').value = m.marca || '';
  document.getElementById('reqModelo').value = m.modelo || '';
}

function criarRequisicao(){
  if(!currentUser || currentUser.role !== 'Técnico'){ alert('Apenas Técnicos podem criar requisições.'); return; }

  const solicitanteName = currentUser.name && currentUser.name.trim() ? currentUser.name : currentUser.username;
  const solicitanteUser = currentUser.username;

  const prodIndex = Number(document.getElementById('selProduto').value);
  if(isNaN(prodIndex)){ alert('Selecione um produto'); return; }

  const qtd = Number(document.getElementById('reqQtd').value || 1);
  const marca = (document.getElementById('reqMarca').value || '').trim();
  const modelo = (document.getElementById('reqModelo').value || '').trim();

  const mat = materiais[prodIndex];
  if(!mat){ alert('Produto inválido'); return; }
  if(qtd <= 0){ alert('Quantidade inválida'); return; }

  // baixa de estoque
  if(qtd > mat.qtd){
    if(!confirm(`Quantidade solicitada (${qtd}) é maior que disponível (${mat.qtd}). Continuar? O estoque ficará zerado.`))
      return;
    mat.qtd = 0;
  } else {
    mat.qtd = mat.qtd - qtd;
  }

  // registra requisição com solicitante
  requisicoes.unshift({
    id: 'REQ-'+Date.now(),
    produtoId: mat.id,
    produtoNome: mat.nome,
    marca: marca || mat.marca || '',
    modelo: modelo || mat.modelo || '',
    qtd,
    solicitanteUser,
    solicitanteName,
    status: 'Enviado',
    criadoEm: new Date().toISOString()
  });

  saveAll();
  alert('Requisição enviada. Estoque atualizado.');

  if(mat.min !== undefined && mat.qtd <= mat.min){
    alert(`⚠️ Atenção: o item "${mat.nome}" atingiu o estoque mínimo (mín: ${mat.min}). Qtd atual: ${mat.qtd}.`);
  }

  renderMateriais();
  renderMateriaisForTech();
  renderRequisicoes();

  document.getElementById('reqMarca').value = '';
  document.getElementById('reqModelo').value = '';
  document.getElementById('reqQtd').value = 1;
}

function renderRequisicoes(){
  const tb = document.getElementById('tbRequisicoes'); if(!tb) return;
  tb.innerHTML = '';
  requisicoes.forEach((r)=>{
    if(currentUser && currentUser.role === 'Técnico' && r.solicitanteUser !== currentUser.username) return;
    tb.innerHTML += `<tr>
      <td>${r.id}</td><td>${r.produtoNome}</td><td>${r.marca || '—'}</td><td>${r.modelo || '—'}</td><td>${r.qtd}</td><td>${r.solicitanteName || r.solicitanteUser || '—'}</td><td>${r.status}</td>
    </tr>`;
  });
}

/* ========= util ========= */
function hardReset(){
  try{
    localStorage.removeItem('sys_users');
    localStorage.removeItem('sys_materiais');
    localStorage.removeItem('sys_requisicoes');
    localStorage.removeItem('sys_currentUser');
    localStorage.removeItem('sys_login_attempts');
    localStorage.removeItem('sys_login_lock_until');
  }catch(e){}
  location.reload();
}
window.hardReset = hardReset;

/* ========= Inicialização ========= */
ensureDefaultUsers();
fixLegacyRequisicoes();  // completa nome do solicitante em registros antigos
if(!currentUser){
  document.getElementById('loginOverlay').style.display = '';
  document.getElementById('appHeader').style.display = 'none';
  document.getElementById('appContainer').style.display = 'none';
  document.getElementById('btnLogout').style.display = 'none';
} else {
  document.getElementById('loginOverlay').style.display = 'none';
  document.getElementById('appHeader').style.display = '';
  document.getElementById('appContainer').style.display = '';
  document.getElementById('btnLogout').style.display = 'inline-block';
}
atualizarUI();

/* ========= Expor ========= */
window.login = login;
window.logout = logout;
window.show = show;
window.adicionarMaterial = adicionarMaterial;
window.delMaterial = delMaterial;
window.criarUsuario = criarUsuario;
window.alterarRole = alterarRole;
window.deletarUsuario = deletarUsuario;
window.criarRequisicao = criarRequisicao;
window.onProdutoChange = onProdutoChange;
</script>
</body>
</html>
